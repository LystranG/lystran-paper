---
type Heading = {
  depth: number;
  slug: string;
  text: string;
};

import ArticleOutlineIsland, {
  type TocNode,
} from "@/components/ArticleOutlineIsland";
import IconList from "@/assets/icons/IconList.svg";

type Props = {
  headings: Heading[];
  title?: string;
  minDepth?: number;
  maxDepth?: number;
  className?: string;
};

const {
  headings,
  title = "大纲",
  minDepth = 2,
  maxDepth = 4,
  className = "",
} = Astro.props;

const toc = (headings ?? []).filter(h => {
  const isInRange = h.depth >= minDepth && h.depth <= maxDepth;
  const hasText = Boolean(h.text?.trim());
  const hasSlug = Boolean(h.slug?.trim());
  // 兼容项目内 remark-toc 生成的“目录”标题，避免大纲里出现“目录 -> 目录...”
  const isDirectoryHeading = h.text?.trim() === "目录";
  return isInRange && hasText && hasSlug && !isDirectoryHeading;
});

const buildTree = (items: Heading[]): TocNode[] => {
  const root: TocNode[] = [];
  const stack: { depth: number; node: TocNode }[] = [];
  let index = 0;

  for (const heading of items) {
    const node: TocNode = {
      id: String(index++),
      heading,
      children: [],
    };

    while (stack.length > 0 && heading.depth <= stack[stack.length - 1]!.depth) {
      stack.pop();
    }

    const parent = stack[stack.length - 1]?.node;
    if (parent) parent.children.push(node);
    else root.push(node);

    stack.push({ depth: heading.depth, node });
  }

  return root;
};

const tree = buildTree(toc);
---

{
  tree.length > 0 && (
    <aside class:list={[className]} aria-label="文章大纲">
      <div class="article-outline-shell" data-outline-shell data-collapsed="auto">
        <div
          class="article-outline-panel"
          id="article-outline-panel"
          data-outline-panel
        >
          <div class="article-outline__header">
            <span class="article-outline__title">{title}</span>
            <button
              type="button"
              class="article-outline__panel-toggle"
              data-outline-toggle
              aria-controls="article-outline-nav"
              aria-expanded="true"
              aria-label="收起大纲"
            >
              <IconList class="article-outline__panel-toggle-icon" aria-hidden="true" />
            </button>
          </div>
          <nav
            id="article-outline-nav"
            class="article-outline__nav"
            aria-label="文章大纲导航"
          >
            <ArticleOutlineIsland
              client:visible
              nodes={tree}
              baseId="article-outline"
            />
          </nav>
        </div>
      </div>
    </aside>
  )
}

<style is:global>
  :root {
    --article-outline-right: 1rem;
    --article-outline-width: 18rem;
  }

  .article-outline-shell {
    position: fixed;
    top: var(--article-outline-top, 6rem);
    right: var(--article-outline-right);
    z-index: 30;
  }

  .article-outline-panel {
    width: var(--article-outline-width);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    background: color-mix(in oklab, var(--color-background) 85%, transparent);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    transition:
      width 180ms ease,
      border-radius 180ms ease;
    overflow: hidden;
  }

  .article-outline__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.65rem 0.75rem;
    font-size: 1rem;
    font-weight: 600;
    color: color-mix(in oklab, var(--color-foreground) 90%, transparent);
    border-bottom: 1px solid color-mix(in oklab, var(--color-border) 80%, transparent);
  }

  .article-outline__title {
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition:
      max-width 180ms ease,
      opacity 180ms ease,
      transform 180ms ease;
    max-width: 14rem;
  }

  .article-outline__panel-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 0.6rem;
    color: color-mix(in oklab, var(--color-foreground) 70%, transparent);
    transition: color 150ms ease, background-color 150ms ease;
  }

  .article-outline__panel-toggle:hover,
  .article-outline__panel-toggle:focus-visible {
    background: color-mix(in oklab, var(--color-muted) 35%, transparent);
    color: var(--color-accent);
  }

  .article-outline__panel-toggle-icon {
    width: 1.25rem;
    height: 1.25rem;
  }

  .article-outline__nav {
    max-height: calc(100vh - 10rem);
    overflow: auto;
    padding: 0.6rem 0.75rem 0.75rem;
    font-size: 1rem;
    opacity: 1;
    visibility: visible;
    transition:
      opacity 180ms ease,
      visibility 0s linear 0s,
      padding 180ms ease,
      max-height 180ms ease;
  }

  .article-outline__list {
    display: grid;
    gap: 0.25rem;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .article-outline__children {
    display: grid;
    margin-inline-start: 0.85rem;
    margin-top: 0.25rem;
    padding-inline-start: 0.25rem;
    border-inline-start: 1px solid
      color-mix(in oklab, var(--color-border) 70%, transparent);
    grid-template-rows: 1fr;
    opacity: 1;
    visibility: visible;
    transition:
      grid-template-rows 200ms ease,
      opacity 200ms ease,
      visibility 0s linear 0s;
  }

  .article-outline__children[data-collapsed="true"] {
    grid-template-rows: 0fr;
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
    transition:
      grid-template-rows 200ms ease,
      opacity 200ms ease,
      visibility 0s linear 200ms;
  }

  .article-outline__children-inner {
    overflow: hidden;
  }

  .article-outline__row {
    display: grid;
    grid-template-columns: 1rem minmax(0, 1fr);
    align-items: center;
    gap: 0.25rem;
  }

  .article-outline__toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1rem;
    height: 1rem;
    border-radius: 0.25rem;
    color: color-mix(in oklab, var(--color-foreground) 70%, transparent);
    transition: transform 150ms ease, color 150ms ease, background-color 150ms ease;
  }

  .article-outline__toggle:hover,
  .article-outline__toggle:focus-visible {
    background: color-mix(in oklab, var(--color-muted) 35%, transparent);
    color: var(--color-accent);
  }

  .article-outline__toggle[aria-expanded="false"] {
    transform: rotate(-90deg);
  }

  .article-outline__spacer {
    width: 1rem;
    height: 1rem;
  }

  .article-outline__link {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: color-mix(in oklab, var(--color-foreground) 80%, transparent);
  }

  .article-outline__link:hover,
  .article-outline__link:focus-visible {
    color: var(--color-accent);
  }

  .article-outline__link--active {
    color: var(--color-accent);
    font-weight: 600;
  }

  .article-outline-shell[data-collapsed="true"] .article-outline-panel {
    width: 3rem;
    border-radius: 0.9rem;
  }

  .article-outline-shell[data-collapsed="true"] .article-outline__title {
    max-width: 0;
    opacity: 0;
    transform: translate3d(-6px, 0, 0);
    pointer-events: none;
  }

  .article-outline-shell[data-collapsed="true"] .article-outline__nav {
    max-height: 0;
    padding: 0;
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
    transition:
      opacity 180ms ease,
      visibility 0s linear 180ms,
      padding 180ms ease,
      max-height 180ms ease;
  }

  .article-outline-shell[data-collapsed="true"] .article-outline__header {
    padding: 0.35rem;
    border-bottom: 0;
    gap: 0;
  }

  /* 小屏：默认只显示悬浮按钮，面板从右下角弹出 */
  @media (max-width: 1023.98px) {
    :root {
      --article-outline-right: 0.75rem;
      --article-outline-width: min(20rem, calc(100vw - 1.5rem));
    }

    .article-outline-shell {
      right: var(--article-outline-right);
    }

    .article-outline-panel {
      transform-origin: bottom right;
    }

    .article-outline__nav {
      max-height: min(60vh, 26rem);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .article-outline__toggle {
      transition: none;
    }

    .article-outline__children,
    .article-outline__children[data-collapsed="true"] {
      transition: none;
    }

    .article-outline__panel-toggle,
    .article-outline__nav,
    .article-outline__title,
    .article-outline-panel {
      transition: none;
    }
  }
</style>

<script is:inline data-astro-rerun>
  function updateArticleOutlineTopOffset() {
    const shells = Array.from(document.querySelectorAll("[data-outline-shell]"));
    if (shells.length === 0) return;

    const topNav =
      document.querySelector("#top-nav-wrap") ?? document.querySelector("header");
    let bottom = 0;
    if (topNav instanceof HTMLElement) {
      bottom = topNav.getBoundingClientRect().bottom;

      const logo = topNav.querySelector('a[href="/"]');
      if (logo instanceof HTMLElement) {
        bottom = Math.max(bottom, logo.getBoundingClientRect().bottom);
      }

      const menuBtn = topNav.querySelector("#menu-btn");
      if (menuBtn instanceof HTMLElement) {
        bottom = Math.max(bottom, menuBtn.getBoundingClientRect().bottom);
      }
    }

    let topPx = 96;
    if (bottom > 0) topPx = Math.max(12, Math.round(bottom + 12));

    for (const shell of shells) {
      if (!(shell instanceof HTMLElement)) continue;
      shell.style.setProperty("--article-outline-top", `${topPx}px`);
    }
  }

  function initArticleOutlineShell() {
    const shells = Array.from(document.querySelectorAll("[data-outline-shell]"));
    for (const shell of shells) {
      if (!(shell instanceof HTMLElement)) continue;
      if (shell.dataset.bound === "true") continue;
      shell.dataset.bound = "true";

      const panel = shell.querySelector("[data-outline-panel]");
      const toggle = shell.querySelector("[data-outline-toggle]");

      if (!(panel instanceof HTMLElement)) continue;
      if (!(toggle instanceof HTMLButtonElement)) continue;

      const setCollapsed = collapsed => {
        const isCollapsed = Boolean(collapsed);
        shell.dataset.collapsed = isCollapsed ? "true" : "false";

        toggle.setAttribute("aria-expanded", isCollapsed ? "false" : "true");
        toggle.setAttribute("aria-label", isCollapsed ? "展开大纲" : "收起大纲");
      };

      toggle.addEventListener("click", () => {
        const current = shell.dataset.collapsed === "true";
        setCollapsed(!current);
      });

      const initial = shell.dataset.collapsed;
      if (initial === "true") {
        setCollapsed(true);
      } else if (initial === "false") {
        setCollapsed(false);
      } else {
        const shouldCollapse = window.matchMedia("(max-width: 1023.98px)").matches;
        setCollapsed(shouldCollapse);
      }
    }

    if (document.documentElement.dataset.articleOutlineTopBound !== "true") {
      document.documentElement.dataset.articleOutlineTopBound = "true";
      let raf = 0;
      const onViewportChange = () => {
        if (raf) return;
        raf = window.requestAnimationFrame(() => {
          raf = 0;
          updateArticleOutlineTopOffset();
        });
      };
      window.addEventListener("resize", onViewportChange);
      window.addEventListener("scroll", onViewportChange, { passive: true });

      const header =
        document.querySelector("#top-nav-wrap") ??
        document.querySelector("header");
      if (
        header instanceof HTMLElement &&
        "ResizeObserver" in window &&
        document.documentElement.dataset.articleOutlineHeaderObserverBound !==
          "true"
      ) {
        document.documentElement.dataset.articleOutlineHeaderObserverBound = "true";
        const observer = new ResizeObserver(() => onViewportChange());
        observer.observe(header);
      }
    }

    updateArticleOutlineTopOffset();
  }

  initArticleOutlineShell();
  document.addEventListener("astro:page-load", initArticleOutlineShell);
</script>
